<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <title>Falco Rules Explorer</title>
    <meta name="author" content="">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.12.1/js/dataTables.bootstrap5.min.js"></script>
    <style>
        .dataTables_filter {
            padding-right: 10px;
        }
        .dataTables_length {
            padding-left: 10px;
        }
        .name {
            font-weight: bold;
        }
        .btn {
            padding-bottom: 15px;
        }
        .list {
            font-size: 105%;
            background-color: #b41616;
        }
        .macro {
            font-size: 105%;
            background-color: #1138c7;
        }
        .rule {
            font-size: 105%;
            background-color: #06a16d;
        }
        .enabled {
            background-color: #017f33;
        }
        .disabled {
            background-color: #cc0047d7;
        }
        .tag {
            margin-right: 2px;
        }
        a:link { text-decoration: none; }
        .form-select {
            margin-left: 16px;
            margin-bottom: 5px;
            display: inline;
        }
    </style>
    </head>
    <body>
    <div>
        <a href="./index.html"><img src="https://sysdig.com/wp-content/uploads/2018/10/Falco-horizontal-logo-teal_2x.png" height="55" alt="falco logo"></a>
    </div>
    <div id="types" style="padding-left: 10px;">
        Type:
    </div>
    <div id="statuses" style="padding-left: 10px;">
        Status:
    </div>
    <table id="rules" class="table table-striped table-condensed" style="padding-left: 10px;">
        <thead>
            <tr>
                <th>Type</th>
                <th>Name</th>
                <th>File</th>
                <th>Tags</th>
                <th>Status</th> 
            </tr>
        </thead>
    </table>
    </body>
    <script>
        const types = ['all', 'list', 'macro', 'rule']
        types.forEach ((item) => {
            var searchPrms = new URLSearchParams(window.location.search);
            var selected = searchPrms.get('type');
            searchPrms.set('type', item);
            var element = document.createElement('a');
            element.className = "btn btn-outline-primary btn-sm";
            if (selected == item) {
                element.className = "btn btn-primary btn-sm";
            }
            element.style = "margin: 5px; padding-top: 8px; padding-bottom: 10px;"
            element.text = item;
            element.href = "?"+searchPrms.toString();
            document.getElementById('types').appendChild(element);
        });
        const statuses = ['all', 'disabled', 'enabled']
        statuses.forEach ((item) => {
            var searchPrms = new URLSearchParams(window.location.search);
            var selected = searchPrms.get('status');
            searchPrms.set('status', item);
            var element = document.createElement('a');
            element.className = "btn btn-outline-primary btn-sm";
            if (selected == item) {
                element.className = "btn btn-primary btn-sm";
            }
            element.style = "margin: 5px; padding-top: 8px; padding-bottom: 10px;"
            element.text = item;
            element.href = "?"+searchPrms.toString();
            document.getElementById('statuses').appendChild(element);
        });

        var stringToColor = function(str) {
            var hash = 0;
            for(var i=0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 3) - hash);
            }
            var color = Math.abs(hash).toString(16).substring(0, 6);
            return "#" + '000000'.substring(0, 6 - color.length) + color;
        }

        var searchPrms = new URLSearchParams(window.location.search);
        var search = searchPrms.get('search');
        if (search == null) {
            search = ""
        }
        var type = searchPrms.get('type');
        if (type == null || type == "all") {
            type = ".*"
        }
        var status = searchPrms.get('status');
        if (status == null || status == "all" || type !== "rule") {
            status = ".*"
        }
        $(document).ready(function() {
            $('#rules').DataTable({
                ajax: {
                    url: "./index.json",
                    dataSrc: ""
                },
                "searchCols": [
                    { "search": type, "regex": true },
                    null,
                    null,
                    null,
                    { "search": status, "regex": true },
                ],
                "search": {"search": search },
                "paging": true,
                "pageLength": 100,
                "order": [[ 0, "asc" ]],
                columns : [
                    { "data" : "type",
                        render: function (data) {
                            if (data === "list") {
                                return '<span class="badge list">'+data+'</span>';
                            }
                            if (data === "macro") {
                                return '<span class="badge macro">'+data+'</span>';
                            }
                            if (data === "rule") {
                                return '<span class="badge rule">'+data+'</span>';
                            }
                            return '<span class="badge">'+data+'</span>';
                        },
                    },
                    { "data" : "name",
                        "width": "33%",
                        render: function (data, type, row, meta) {
                            var url = "./rule.html?hash=" + row['hash']
                            return '<span class="name"><a href="' + url + '"><i class="bi bi-binoculars"></i></a> ' + data + '</span>';
                        },
                    },
                    { "data" : "file_name",
                        render: function (data, type, row, meta) {
                            return '<a href="' + row['permalink'] + '"><i class="bi bi-link"></i> ' + data + '</a>';
                        },
                    },
                    { "data" : "tags",
                        render: function (data) {
                            var t = '';
                            if (data == null) {
                                return t;
                            }
                            Object.entries(data).forEach (([key, value]) => {
                                var c = stringToColor(value);
                                t = t + '<span class="badge tag" style="background-color:'+ c +';">'+value+'</span>';
                            });
                            return t;
                        },
                    },
                    { "data" : "enabled",
                        render: function (data, type, row, meta) {
                            if (row['type'] !== 'rule') {
                                return '';
                            }
                            if (data === "false") {
                                return '<span class="badge disabled">disabled</span>';
                            }
                            return '<span class="badge enabled">enabled</span>';
                        },
                    },
                ]
            });
        });
        </script>
</html>